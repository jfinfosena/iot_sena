# Guía Básica: ESP32 con MQTT y LED RGB

## Descripción del Ejercicio

Este ejercicio demuestra cómo crear un sistema de control remoto para un LED RGB usando un ESP32-C3 y el protocolo MQTT. El proyecto permite:

- **Conectar el ESP32 a una red WiFi**
- **Establecer comunicación MQTT con un broker público**
- **Controlar un LED RGB de forma remota** mediante mensajes MQTT
- **Recibir comandos desde cualquier cliente MQTT** (aplicación web, móvil, etc.)

### ¿Qué hace el código?

1. **Inicialización**: Configura el LED RGB y establece conexión WiFi
2. **Conexión MQTT**: Se conecta al broker público `broker.emqx.io`
3. **Suscripción**: Escucha mensajes en el tema `modulo1`
4. **Control del LED**: Cambia el color del LED según los comandos recibidos:
   - `red` → LED rojo
   - `green` → LED verde
   - `blue` → LED azul
   - `off` → LED apagado

### Aplicaciones Prácticas

- Domótica básica
- Indicadores de estado remotos
- Sistemas de notificación visual
- Prototipado IoT

## Requisitos

- ESP32-C3 o compatible
- Arduino IDE instalado
- Conexión WiFi
- Cable USB para programar el ESP32

## Librerías Necesarias

Instala las siguientes librerías en Arduino IDE:

1. **WiFi** (incluida por defecto)
2. **PubSubClient** - Para comunicación MQTT
3. **Adafruit NeoPixel** - Para controlar el LED RGB

### Instalación de librerías:
1. Abre Arduino IDE
2. Ve a `Herramientas > Administrar Bibliotecas`
3. Busca e instala:
   - `PubSubClient` por Nick O'Leary
   - `Adafruit NeoPixel` por Adafruit

## Configuración del Hardware

1. **Conecta el ESP32** al computador usando cable USB
2. **Selecciona la placa** en Arduino IDE:
   - Ve a `Herramientas > Placa > ESP32 Arduino > ESP32C3 Dev Module`
3. **Selecciona el puerto** correcto en `Herramientas > Puerto`

## Código Completo

```cpp
#include <WiFi.h>
#include <PubSubClient.h>
#include <Adafruit_NeoPixel.h>

#define RGB_LED_PIN 8 // Pin GPIO para el LED RGB (ajusta si es diferente en tu placa)
#define NUM_PIXELS 1  // Número de LEDs (1 para el LED RGB integrado)

Adafruit_NeoPixel rgbLed(NUM_PIXELS, RGB_LED_PIN, NEO_GRB + NEO_KHZ800);

String broker = "broker.emqx.io";
int port = 1883;
String TopicSubscribe = "modulo1";

WiFiClient wifiClient;
PubSubClient wifiMQTT(wifiClient);

void mqttCallback(char* topic, byte* payload, unsigned int length) {
  String mqttdata = "";
  for (int i = 0; i < length; i++) {
    mqttdata += (char)payload[i];
  }
  
  Serial.print("Mensaje MQTT recibido: ");
  Serial.println(mqttdata);
  
  // Controlar el LED RGB según el mensaje MQTT
  if (mqttdata == "red") {
    rgbLed.setPixelColor(0, rgbLed.Color(255, 0, 0)); // Rojo
    rgbLed.show();
    Serial.println("LED RGB configurado a Rojo");
  } else if (mqttdata == "green") {
    rgbLed.setPixelColor(0, rgbLed.Color(0, 255, 0)); // Verde
    rgbLed.show();
    Serial.println("LED RGB configurado a Verde");
  } else if (mqttdata == "blue") {
    rgbLed.setPixelColor(0, rgbLed.Color(0, 0, 255)); // Azul
    rgbLed.show();
    Serial.println("LED RGB configurado a Azul");
  } else if (mqttdata == "off") {
    rgbLed.setPixelColor(0, rgbLed.Color(0, 0, 0)); // Apagado
    rgbLed.show();
    Serial.println("LED RGB apagado");
  } else {
    Serial.println("Comando desconocido");
  }
}

void setup() {
  Serial.begin(115200); // Inicializar comunicación serial a 115200 baudios
  Serial.println("Iniciando Cliente MQTT con LED RGB para ESP32-C3...");
  
  rgbLed.begin(); // Inicializar el LED RGB
  rgbLed.setBrightness(50); // Establecer brillo (0-255, ajusta según necesidad)
  rgbLed.setPixelColor(0, rgbLed.Color(0, 0, 0)); // Iniciar con LED apagado
  rgbLed.show();
  Serial.println("LED RGB inicializado");

  Serial.print("Conectando a WiFi...");
  WiFi.begin("SENAF", "1234567890qwe");
  while (WiFi.status() != WL_CONNECTED) {
    delay(100);
    Serial.print(".");
  }
  Serial.println("\nWiFi conectado");
  
  wifiMQTT.setServer(broker.c_str(), port);
  wifiMQTT.setCallback(mqttCallback);
  Serial.println("Conectando al broker MQTT...");
  
  if (wifiMQTT.connect("myClient", "admin", "1234567890")) {
    Serial.println("MQTT conectado");
    wifiMQTT.subscribe(TopicSubscribe.c_str());
    Serial.print("Suscrito al tema: ");
    Serial.println(TopicSubscribe);
  } else {
    Serial.println("Fallo en la conexión MQTT");
  }
}

void loop() {
  wifiMQTT.loop();
}
```

## Configuración del Código

### Parámetros WiFi
Modifica estas líneas en el código según tu red:
```cpp
WiFi.begin("TU_WIFI", "TU_PASSWORD");
```

### Configuración MQTT
El código usa:
- **Broker**: `broker.emqx.io` (público)
- **Puerto**: `1883`
- **Tema**: `modulo1`
- **Usuario**: `admin`
- **Contraseña**: `1234567890`

## Guía Paso a Paso para Ejecutar

### Paso 1: Preparación del Entorno

1. **Instala Arduino IDE** (versión 2.0 o superior recomendada)
2. **Configura el soporte para ESP32**:
   - Ve a `Archivo > Preferencias`
   - En "URLs Adicionales de Gestor de Tarjetas" agrega:
     ```
     https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
     ```
   - Ve a `Herramientas > Placa > Gestor de Tarjetas`
   - Busca "ESP32" e instala "ESP32 by Espressif Systems"

### Paso 2: Instalación de Librerías

1. **Abre el Gestor de Librerías** (`Herramientas > Administrar Bibliotecas`)
2. **Instala las siguientes librerías**:
   - Busca `PubSubClient` → Instala "PubSubClient by Nick O'Leary"
   - Busca `Adafruit NeoPixel` → Instala "Adafruit NeoPixel by Adafruit"

### Paso 3: Configuración del Hardware

1. **Conecta el ESP32-C3** al computador usando cable USB
2. **Selecciona la configuración correcta**:
   - **Placa**: `Herramientas > Placa > ESP32 Arduino > ESP32C3 Dev Module`
   - **Puerto**: `Herramientas > Puerto > [Selecciona el puerto COM correspondiente]`
   - **Velocidad de subida**: `921600`

### Paso 4: Configuración del Código

1. **Copia el código completo** (sección "Código Completo" arriba)
2. **Modifica los parámetros WiFi**:
   ```cpp
   WiFi.begin("TU_NOMBRE_WIFI", "TU_PASSWORD_WIFI");
   ```
3. **Opcional**: Cambia el tema MQTT si deseas:
   ```cpp
   String TopicSubscribe = "tu_tema_personalizado";
   ```

### Paso 5: Carga y Verificación

1. **Compila y sube el código**:
   - Presiona `Ctrl+U` o haz clic en el botón "Subir" (→)
   - Espera a que termine la compilación y carga

2. **Abre el Monitor Serie**:
   - Ve a `Herramientas > Monitor Serie`
   - Configura velocidad a `115200 baudios`
   - Presiona el botón RESET del ESP32 si es necesario

3. **Verifica la conexión exitosa**:
   ```
   Iniciando Cliente MQTT con LED RGB para ESP32-C3...
   LED RGB inicializado
   Conectando a WiFi........
   WiFi conectado
   Conectando al broker MQTT...
   MQTT conectado
   Suscrito al tema: modulo1
   ```

### Paso 6: Prueba del Sistema

1. **Si ves todos los mensajes de conexión exitosa**, el sistema está listo
2. **El LED debería estar apagado inicialmente**
3. **Procede a la sección "Prueba con Cliente Web MQTT"** para enviar comandos

## Prueba con Cliente Web MQTT

1. **Abre el cliente web**: [MQTTX Web Client](https://mqttx.app/web-client#/recent_connections/8e06dcc1-d21b-4525-867c-239cfa87c749)

2. **Configura la conexión**:
   - **Host**: `broker.emqx.io`
   - **Puerto**: `1883`
   - **Username**: `admin`
   - **Password**: `1234567890`
   - Haz clic en "Connect"

3. **Envía comandos**:
   - **Tema**: `modulo1`
   - **Mensajes disponibles**:
     - `red` - LED rojo
     - `green` - LED verde
     - `blue` - LED azul
     - `off` - LED apagado

4. **Verifica funcionamiento**:
   - Envía cada comando desde el cliente web
   - Observa el cambio de color en el LED del ESP32
   - Revisa los mensajes en el Monitor Serie

## Comandos de Prueba

| Comando | Resultado |
|---------|----------|
| `red` | LED se enciende en rojo |
| `green` | LED se enciende en verde |
| `blue` | LED se enciende en azul |
| `off` | LED se apaga |

## Solución de Problemas

- **No conecta WiFi**: Verifica nombre y contraseña de red
- **No conecta MQTT**: Revisa conexión a internet
- **LED no cambia**: Verifica pin GPIO 8 y conexiones
- **Sin mensajes**: Confirma que el tema sea exactamente `modulo1`

¡Listo! Tu ESP32 debería responder a los comandos MQTT cambiando el color del LED RGB.